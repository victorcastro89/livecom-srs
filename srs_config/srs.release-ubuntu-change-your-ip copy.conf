#!!! Important: SRS will restore this file during each restart, please never modify it.

# The config for LigthHouse SRS.
# See https://github.com/ossrs/srs/blob/develop/trunk/conf/full.conf

listen              1935;
max_connections     1000;

# For docker, please use docker logs to manage the logs of SRS.
# See https://docs.docker.com/config/containers/logging/
srs_log_tank        file;
srs_log_level       verbose;
daemon              off;
http_api {
    enabled         on;
    listen          1985;
    raw_api {
        enabled on;
        allow_reload on;
    }
}
http_server {

    enabled         on;
    listen          8080;
    dir             ./objs/nginx/html;
}
rtc_server {
    enabled on;
    listen 8000; # UDP port
    # @see https://github.com/ossrs/srs/wiki/v4_CN_WebRTC#config-candidate
    candidate   $CANDIDATE;
}



include containers/data/config/srs.server.conf;

vhost __defaultVhost__ {

transcode {
    enabled on;
    ffmpeg ./objs/ffmpeg/bin/ffmpeg;
    
    engine 360p {
        enabled on;
        iformat flv;
        vcodec libx264;
        vprofile main;
        vpreset fast;
        vparams {
            crf 40;
            maxrate 600k;
            bufsize 1200k;
        }
        vfps 25;
        vwidth 640;
        vheight 360;
        vthreads 1;     
        acodec aac;
        abitrate 64; 
        asample_rate 44100;
        achannels 2;
        aparams {
            profile:a aac_low;
        }
        
        oformat flv;
        output rtmp://127.0.0.1:[port]/[app]?vhost=[vhost]/[stream]_360p;
    }
    
    engine 480p {
        enabled on;
        iformat flv;
        vcodec libx264;
        vprofile main;
        vpreset fast;
        vparams {
            crf 40;
            maxrate 1200k;
            bufsize 2400k;
        }
        vfps 25;
        vwidth 854;
        vheight 480;
        vthreads 1;
        
        acodec aac;
        abitrate 64; 
        asample_rate 44100;
        achannels 2;
        aparams {
            profile:a aac_low;
        }
        
        oformat flv;
        output rtmp://127.0.0.1:[port]/[app]?vhost=[vhost]/[stream]_480p;
    }

     engine 720p {
        enabled on;
        iformat flv;
        vcodec libx264;
        vprofile main;
        vbitrate 3000;
        vpreset fast;
        vparams {
            crf 40;
            maxrate 2400k;
            bufsize 4800k;
        }
        vfps 25;
        vwidth 1280;
        vheight 720;
        vthreads 1;
        
        acodec aac;
        abitrate 128; 
        asample_rate 44100;
        achannels 2;
        aparams {
            profile:a aac_low;
        }
        
        oformat flv;
        output rtmp://127.0.0.1:[port]/[app]?vhost=[vhost]/[stream]_720p;
    }
   
}

# exec {
#     enabled on;
#     publish {
        
#           ffmpeg  ./objs/ffmpeg/bin/ffmpeg \
#   -f flv -i rtmp://127.0.0.1:1935/live?vhost=__defaultVhost__/livestream \
#   -map 0:v -map 0:a -s:v:0 640x360 -aspect:v:0 16:9 -b:v:0 600k -c:v:0 libx264 -c:a:0 aac -b:a:0 64k \
#   -map 0:v -map 0:a -s:v:1 854x480 -aspect:v:1 16:9 -b:v:1 1200k -c:v:1 libx264 -c:a:1 aac -b:a:1 64k \
#   -f dash -use_template 1 -use_timeline 1 \
#   -adaptation_sets "id=0,streams=v id=1,streams=a" \
#   -y ./objs/nginx/html/live/my.mpd;

#     }
# }



    http_remux {
        enabled     on;
        mount       [vhost]/[app]/[stream].flv;
    }
    rtc {
        enabled     on;
        # nack on;
        # twcc on;
        # stun_timeout 30;
        # dtls_role passive;
        # @see https://github.com/ossrs/srs/wiki/v4_CN_WebRTC#rtmp-to-rtc
        rtmp_to_rtc on;
        # keep_bframe off;
        # @see https://github.com/ossrs/srs/wiki/v4_CN_WebRTC#rtc-to-rtmp
        rtc_to_rtmp on;
        # pli_for_rtmp 6.0;
    }

    http_hooks {
        enabled         on;
        # on_publish      http://wsl2:2024/terraform/v1/hooks/srs/verify;
        # on_unpublish    http://wsl2:2024/terraform/v1/hooks/srs/verify;
        # on_play         http://wsl2:2024/terraform/v1/hooks/srs/verify;
        # on_stop         http://wsl2:2024/terraform/v1/hooks/srs/verify;
        # on_hls          http://wsl2:2024/terraform/v1/hooks/srs/hls;

        on_publish      http://wsl2:2022/webapi/verify;
        on_unpublish    http://wsl2:2022/webapi/verify;
        on_play         http://wsl2:2022/webapi/verify;
        on_stop         http://wsl2:2022/webapi/verify;
        # on_hls          http://wsl2:2022/webapi/verify;
    }

    #    dash {
    #     enabled         on;
    #     dash_fragment       2;
    #     dash_update_period  5;
    #     dash_timeshift     1800;
    #     dash_window_size    900;
    #     dash_path           ./objs/nginx/html;
    #     dash_mpd_file       [app]/[stream].mpd;
    # }
     include containers/data/config/srs.vhost.conf;



}

