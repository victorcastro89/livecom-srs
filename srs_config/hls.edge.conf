
# # Note that this is for NGINX server, not SRS.

# worker_processes  1;

# events {
#     worker_connections  10240;
# }

# http {

#     # For Proxy Cache.
#     proxy_cache_path  /tmp/nginx-cache levels=1:2 keys_zone=srs_cache:8m max_size=1000m inactive=600m;
#     proxy_temp_path /tmp/nginx-cache/tmp; 

#     server {
#         listen       8081;

#     #RESOLVER FOR DOCKER
#     resolver 127.0.0.11 valid=30s;


#         # For Proxy Cache.
#         proxy_cache_valid  404      10s;
#         proxy_cache_lock on;
#         proxy_cache_lock_age 300s;
#         proxy_cache_lock_timeout 300s;
#         proxy_cache_min_uses 1;


#                # Handle .m3u8 files
#        location ~ ^/.+/.+\.m3u8$ {
#             proxy_set_header Host $host;
#             proxy_pass http://srs_origin:8080$request_uri; # Repassa diretamente para localhost no porto 8080
#             # For Proxy Cache.
#             proxy_cache srs_cache;
#             proxy_cache_key $scheme$proxy_host$uri$args;
#             proxy_cache_valid  200 302  5s;
#         }

#         location ~ ^/.+/.+\.ts$ {
#               proxy_set_header Host $host;
#             proxy_pass http://srs_origin:8080$request_uri; # Repassa diretamente para localhost no porto 8080
#             # For Proxy Cache.
#             proxy_cache srs_cache;
#             proxy_cache_key $scheme$proxy_host$uri;
#             proxy_cache_valid  200 302  60m;
#         }

#          # Handle DASH .mpd manifest files
#         location ~ ^/.+/.+\.mpd$ {
#             proxy_set_header Host $host;
#             proxy_pass http://srs_origin:8080$request_uri;
#             # For Proxy Cache.
#             proxy_cache srs_cache;
#             proxy_cache_key $scheme$proxy_host$uri$is_args$args;
#             proxy_cache_valid  200 302  5s;
#         }

#         # Handle DASH .m4s segment files
#         location ~ ^/.+/.+\.m4s$ {
#             proxy_set_header Host $host;
#             proxy_pass http://srs_origin:8080$request_uri;
#             # For Proxy Cache.
#             proxy_cache srs_cache;
#             proxy_cache_key $scheme$proxy_host$uri$is_args$args;
#             proxy_cache_valid  200 302  5s;
#         }

#                 location ~ ^/.+/.+\.mp4$ {
#             proxy_set_header Host $host;
#             proxy_pass http://srs_origin:8080$request_uri;
#             # For Proxy Cache.
#             proxy_cache srs_cache;
#             proxy_cache_key $scheme$proxy_host$uri$is_args$args;
#             proxy_cache_valid  200 302  5s;
#         }

#     }
# }


worker_processes 2;

events {
    worker_connections  10240;
}

http {
    # For Proxy Cache.
    proxy_cache_path  /tmp/nginx-cache levels=1:2 keys_zone=srs_cache:8m max_size=1000m inactive=600m;
    proxy_temp_path /tmp/nginx-cache/tmp;

    upstream srs_origin {
        server srs_origin:8080;

        # Ensure to set keepalive to twice the number of servers listed in the upstream block
        keepalive 2;
    }

    server {
        listen 8081;

        # RESOLVER FOR DOCKER
        resolver 127.0.0.11 valid=30s;

        # For Proxy Cache.
        proxy_cache_valid  404      10s;
        proxy_cache_lock on;
        proxy_cache_lock_age 300s;
        proxy_cache_lock_timeout 300s;
        proxy_cache_min_uses 1;

        location / {
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_pass http://srs_origin; # Use the upstream block for proxy_pass

            # For Proxy Cache.
            proxy_cache srs_cache;
            proxy_cache_key $scheme$proxy_host$uri$args;
            proxy_cache_valid  200 302  5s;

            # Enable the buffer of proxy and specify the size
            proxy_buffers 16 32k;
            proxy_buffer_size 64k;
            
            # Configurations for timeout to improve performance
            proxy_connect_timeout 600s;
            proxy_send_timeout 600s;
            proxy_read_timeout 600s;
            send_timeout 600s;
        }
               # Handle .m3u8 files
       location ~ ^/.+/.+\.m3u8$ {
            proxy_set_header Host $host;
            proxy_pass http://srs_origin:8080$request_uri; # Repassa diretamente para localhost no porto 8080
            # For Proxy Cache.
            proxy_cache srs_cache;
            proxy_cache_key $scheme$proxy_host$uri$args;
            proxy_cache_valid  200 302  5s;
        }

        location ~ ^/.+/.+\.ts$ {
              proxy_set_header Host $host;
            proxy_pass http://srs_origin:8080$request_uri; # Repassa diretamente para localhost no porto 8080
            # For Proxy Cache.
            proxy_cache srs_cache;
            proxy_cache_key $scheme$proxy_host$uri;
            proxy_cache_valid  200 302  60m;
        }

         # Handle DASH .mpd manifest files
        location ~ ^/.+/.+\.mpd$ {
            proxy_set_header Host $host;
            proxy_pass http://srs_origin:8080$request_uri;
            # For Proxy Cache.
            proxy_cache srs_cache;
            proxy_cache_key $scheme$proxy_host$uri$is_args$args;
            proxy_cache_valid  200 302  5s;
        }

        # Handle DASH .m4s segment files
        location ~ ^/.+/.+\.m4s$ {
            proxy_set_header Host $host;
            proxy_pass http://srs_origin:8080$request_uri;
            # For Proxy Cache.
            proxy_cache srs_cache;
            proxy_cache_key $scheme$proxy_host$uri$is_args$args;
            proxy_cache_valid  200 302  5s;
        }

                location ~ ^/.+/.+\.mp4$ {
            proxy_set_header Host $host;
            proxy_pass http://srs_origin:8080$request_uri;
            # For Proxy Cache.
            proxy_cache srs_cache;
            proxy_cache_key $scheme$proxy_host$uri$is_args$args;
            proxy_cache_valid  200 302  5s;
        }
   
    }
}
